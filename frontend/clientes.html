<script>
document.addEventListener('DOMContentLoaded', () => {

  const API = location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : 'https://pasnet-backend.onrender.com';

  const lista = document.getElementById('listaClientes');
  const buscador = document.getElementById('buscadorClientes');
  const btnImportar = document.getElementById('btnImportarExcel');
  const excelInput = document.getElementById('excelInput');
  const btnLimpiar = document.getElementById('btnLimpiarClientes');

  let clientesCache = [];

  /* =========================
     CARGAR CLIENTES
  ========================= */
  async function cargarClientes() {
    try {
      const res = await fetch(`${API}/clientes`, {
        credentials: 'include'
      });

      if (res.status === 401) {
        alert('âŒ SesiÃ³n expirada');
        location.href = 'login.html';
        return;
      }

      clientesCache = await res.json();
      renderClientes(clientesCache);

    } catch (err) {
      console.error(err);
      lista.innerHTML = '<p style="opacity:.7">âŒ Error cargando clientes</p>';
    }
  }

  /* =========================
     RENDER CLIENTES
  ========================= */
  function renderClientes(clientes) {
    lista.innerHTML = '';

    if (!clientes.length) {
      lista.innerHTML = '<p style="opacity:.6">No hay clientes registrados</p>';
      return;
    }

    clientes.forEach(c => {
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <h3>${c.nombre || 'Sin nombre'}</h3>
        <p>ğŸ“ ${c.telefono || 'N/A'}</p>
        <p>ğŸ  ${c.direccion || 'N/A'}</p>
        <p>ğŸ’° Deuda: $${c.deuda || 0}</p>
        <p>ğŸ“… Cobro: ${c.fecha_cobro || 'N/A'}</p>
        <p>ğŸ“Œ Estado: ${c.estado || 'pendiente'}</p>
      `;

      lista.appendChild(card);
    });
  }

  /* =========================
     BUSCADOR
  ========================= */
  buscador.addEventListener('input', e => {
    const texto = e.target.value.toLowerCase();

    const filtrados = clientesCache.filter(c =>
      (c.nombre || '').toLowerCase().includes(texto) ||
      (c.telefono || '').includes(texto)
    );

    renderClientes(filtrados);
  });

  /* =========================
     IMPORTAR EXCEL
  ========================= */
  btnImportar.addEventListener('click', async () => {
    const file = excelInput.files[0];

    if (!file) {
      alert('âŒ Selecciona un archivo Excel');
      return;
    }

    const formData = new FormData();
    formData.append('excel', file);

    try {
      const res = await fetch(`${API}/clientes/importar`, {
        method: 'POST',
        credentials: 'include',
        body: formData
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      alert(`âœ… Clientes importados: ${data.importados}`);
      cargarClientes();

    } catch (err) {
      console.error(err);
      alert('âŒ Error importando el Excel');
    }
  });

  /* =========================
     LIMPIAR BASE DE DATOS
  ========================= */
  btnLimpiar.addEventListener('click', async () => {
    const confirmar = confirm('âš ï¸ Esto eliminarÃ¡ TODOS los clientes. Â¿Continuar?');
    if (!confirmar) return;

    const res = await fetch(`${API}/clientes/limpiar`, {
      method: 'DELETE',
      credentials: 'include'
    });

    if (!res.ok) {
      alert('âŒ Error limpiando clientes');
      return;
    }

    alert('âœ… Base de datos limpia');
    clientesCache = [];
    renderClientes([]);
  });

  /* =========================
     INIT
  ========================= */
  cargarClientes();

});
</script>