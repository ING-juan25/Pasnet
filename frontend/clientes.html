<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes | Pasnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>

<!-- ========================= HEADER ========================= -->
<div class="clientes-header">
  <h2>ğŸ“‹ Lista de clientes</h2>
  <input type="search" id="buscadorClientes" placeholder="ğŸ” Buscar cliente...">
</div>

<!-- ========================= CONTENIDO ========================= -->
<main class="container">

  <!-- IMPORTAR EXCEL -->
  <h2>ğŸ“¥ Importar clientes desde Excel</h2>

  <button id="btnLimpiarClientes" style="background:#c0392b;color:#fff;">
    ğŸ§¹ Limpiar base de datos
  </button>

  <input type="file" id="excelInput" accept=".xlsx,.xls">
  <button id="btnImportarExcel">ğŸ“¥ Importar Excel</button>

  <p style="opacity:.7; font-size:14px;">
    El Excel debe contener columnas:
    <b>nombre, telefono, direccion, deuda, fecha_cobro</b>
  </p>

  <hr>

  <!-- LISTA CLIENTES -->
  <section id="listaClientes" class="cards"></section>

</main>

<!-- ========================= SCRIPT ========================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  const API = location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : 'https://pasnet-backend.onrender.com';

  const lista = document.getElementById('listaClientes');
  const buscador = document.getElementById('buscadorClientes');
  const btnImportar = document.getElementById('btnImportarExcel');
  const excelInput = document.getElementById('excelInput');

  let clientesCache = [];

  /* =========================
     CARGAR CLIENTES
  ========================= */
  async function cargarClientes() {
    try {
      const res = await fetch(`${API}/clientes`, {
        credentials: 'include'
      });

      if (res.status === 401) {
        alert('âŒ SesiÃ³n expirada');
        location.href = 'login.html';
        return;
      }

      clientesCache = await res.json();
      renderClientes(clientesCache);

    } catch (err) {
      console.error(err);
      lista.innerHTML = '<p style="opacity:.7">âŒ Error cargando clientes</p>';
    }

    // ğŸ‘‰ BOTÃ“N LIMPIAR (CON BLOQUEO PARA NO DUPLICAR LISTENERS)
    const btnLimpiar = document.getElementById('btnLimpiarClientes');

    if (btnLimpiar && !btnLimpiar.dataset.listener) {
      btnLimpiar.dataset.listener = 'true';

      btnLimpiar.addEventListener('click', async () => {
        if (!confirm('âš ï¸ Esto eliminarÃ¡ TODOS los clientes. Â¿Continuar?')) return;

        const res = await fetch(`${API}/clientes/limpiar`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!res.ok) {
          alert('âŒ Error limpiando clientes');
          return;
        }

        alert('âœ… Base de datos limpia');
        clientesCache = [];
        renderClientes([]);
      });
    }
  }

  /* =========================
     RENDER CLIENTES
  ========================= */
  function renderClientes(clientes) {
    lista.innerHTML = '';

    if (!clientes.length) {
      lista.innerHTML = '<p style="opacity:.6">No hay clientes registrados</p>';
      return;
    }

    clientes.forEach(c => {
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <h3>${c.nombre || 'Sin nombre'}</h3>
        <p>ğŸ“ ${c.telefono || 'N/A'}</p>
        <p>ğŸ  ${c.direccion || 'N/A'}</p>
        <p>ğŸ’° Deuda: $${c.deuda || 0}</p>
        <p>ğŸ“… Cobro: ${c.fecha_cobro || 'N/A'}</p>
        <p>ğŸ“Œ Estado: ${c.estado || 'pendiente'}</p>
      `;

      lista.appendChild(card);
    });
  }

  /* =========================
     BUSCADOR
  ========================= */
  buscador.addEventListener('input', e => {
    const texto = e.target.value.toLowerCase();

    const filtrados = clientesCache.filter(c =>
      (c.nombre || '').toLowerCase().includes(texto) ||
      (c.telefono || '').includes(texto)
    );

    renderClientes(filtrados);
  });

  /* =========================
     IMPORTAR EXCEL
  ========================= */
  btnImportar.addEventListener('click', async () => {
    const file = excelInput.files[0];

    if (!file) {
      alert('âŒ Selecciona un archivo Excel');
      return;
    }

    const formData = new FormData();
    formData.append('excel', file);

    try {
      const res = await fetch(`${API}/clientes/importar`, {
        method: 'POST',
        credentials: 'include',
        body: formData
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      alert(`âœ… Clientes importados: ${data.importados}`);
      cargarClientes();

    } catch (err) {
      console.error(err);
      alert('âŒ Error importando el Excel');
    }
  });

  /* =========================
     INIT
  ========================= */
  cargarClientes();

});
</script>

</body>
</html>