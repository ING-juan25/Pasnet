<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes | Pasnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>

<div class="clientes-header">
  <h2>ðŸ“‹ Lista de clientes</h2>
  <input type="search" id="buscadorClientes" placeholder="ðŸ” Buscar cliente...">
</div>

<main class="container">

  <h2>ðŸ“¥ Importar clientes desde Excel</h2>

  <button id="btnLimpiarClientes" style="background:#c0392b;color:#fff;">
    ðŸ§¹ Limpiar base de datos
  </button>

  <input type="file" id="excelInput" accept=".xlsx,.xls">
  <button id="btnImportarExcel">ðŸ“¥ Importar Excel</button>

  <hr>

  <section id="listaClientes" class="cards"></section>

  <!-- MODAL GLOBAL -->
  <div id="globalModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const API = location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : 'https://pasnet-backend.onrender.com';

  const lista = document.getElementById('listaClientes');
  const buscador = document.getElementById('buscadorClientes');
  const modal = document.getElementById("globalModal");
  const modalBody = document.getElementById("modal-body");
  const closeBtn = document.querySelector(".close-btn");

  let clientesCache = [];
  let clienteActual = null;

  closeBtn.onclick = () => modal.style.display = "none";
  window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

  /* =========================
     CARGAR CLIENTES
  ========================= */
  async function cargarClientes() {
    const res = await fetch(`${API}/clientes`, { credentials:'include' });
    if(res.status === 401) return location.href='login.html';
    clientesCache = await res.json();
    renderClientes(clientesCache);
  }

  /* =========================
     RENDER TARJETAS
  ========================= */
  function renderClientes(clientes){
    lista.innerHTML='';

    clientes.forEach(c => {

      const deuda = Number(c.deuda || 0);
      const abonado = Number(c.abono || 0);
      const total = deuda + abonado;

      const porcentaje = total>0
        ? Math.round((abonado/total)*100)
        : 100;

      const card = document.createElement('div');
      card.className='finance-card';

      card.innerHTML=`
        <div class="card-left">
          <div class="avatar">${c.nombre[0].toUpperCase()}</div>
          <div>
            <h3>${c.nombre}</h3>
            <small>ðŸ“… ${c.fecha_cobro || 'Sin fecha'}</small>
          </div>
        </div>

        <div class="card-right">
          <h2>$${deuda.toLocaleString()}</h2>
          <small>${porcentaje}% pagado</small>
        </div>

        <div class="progress-bar">
          <div class="progress" style="width:${porcentaje}%"></div>
        </div>
      `;

      card.onclick=()=> abrirVistaDetalle(c);
      lista.appendChild(card);
    });
  }

  /* =========================
     VISTA DETALLE
  ========================= */
  async function abrirVistaDetalle(cliente){

    clienteActual = cliente;

    const res = await fetch(`${API}/clientes/${cliente.id}/movimientos`,{
      credentials:'include'
    });

    const movimientos = await res.json();

    let historialHTML='';

    movimientos.forEach(m=>{
      historialHTML+=`
        <div class="mov-item ${m.tipo}">
          <strong>${m.tipo.toUpperCase()}</strong>
          <span>$${Number(m.monto).toLocaleString()}</span>
          <small>${m.fecha}</small>
          <p>${m.concepto || ''}</p>
        </div>
      `;
    });

    modalBody.innerHTML=`
      <h2>${cliente.nombre}</h2>

      <div class="detalle-resumen">
        <p><strong>Deuda:</strong> $${Number(cliente.deuda).toLocaleString()}</p>
        <p><strong>Abonado:</strong> $${Number(cliente.abono).toLocaleString()}</p>
      </div>

      <button onclick="abrirModalMovimiento()">âž• Nuevo Movimiento</button>

      <hr>
      <h3>Historial</h3>
      <div class="historial-container">
        ${historialHTML || '<p style="opacity:.6">Sin movimientos</p>'}
      </div>
    `;

    modal.style.display="flex";
  }

  /* =========================
     MODAL MOVIMIENTO
  ========================= */
  window.abrirModalMovimiento = function(){

    modalBody.innerHTML=`
      <h2>Registrar Movimiento</h2>

      <select id="tipoMovimiento">
        <option value="pago">Pago</option>
        <option value="aumento">Aumento deuda</option>
        <option value="promesa">Promesa</option>
      </select>

      <input type="number" id="montoMovimiento" placeholder="Monto">
      <input type="text" id="conceptoMovimiento" placeholder="Concepto">
      <input type="date" id="fechaMovimiento">

      <button onclick="guardarMovimiento()">Guardar</button>
    `;
  }

  /* =========================
     GUARDAR MOVIMIENTO
  ========================= */
  window.guardarMovimiento = async function(){

    const tipo = document.getElementById('tipoMovimiento').value;
    const monto = Number(document.getElementById('montoMovimiento').value);
    const concepto = document.getElementById('conceptoMovimiento').value;
    const fecha = document.getElementById('fechaMovimiento').value;

    if(!fecha){
      alert("Selecciona una fecha");
      return;
    }

    await fetch(`${API}/clientes/${clienteActual.id}/movimientos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({tipo,monto,concepto,fecha})
    });

    modal.style.display="none";
    cargarClientes();
  }

  /* =========================
     BUSCADOR
  ========================= */
  buscador.oninput=e=>{
    const t=e.target.value.toLowerCase();
    renderClientes(clientesCache.filter(c=>
      c.nombre.toLowerCase().includes(t) ||
      (c.telefono||'').includes(t)
    ));
  };

  cargarClientes();
});
</script>

</body>
</html>